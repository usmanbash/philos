{%- comment -%}
Section: Related Products
Description: This section loops through all products in the related_products metafield,
             and if fewer than 6 products are provided,
             adds random products from the collection['all'].
{%- endcomment -%}

{% liquid
  assign related_products = product.metafields['shopify--discovery--product_recommendation'].related_products.value
  assign all_products = collections['all'].products
  assign max_products = section.settings.num_of_max_products
  assign displayed_products_count = 0
  assign current_product_id = product.id
  assign rendered_products = ''
  # Assign a random starting point to ensure that the same products are not shown every time
  assign random_index = 'now' | date: '%s' | modulo: all_products.size
%}

<section
  x-data="relatedProducts({
    options: {
      spaceBetween: 20,
      navigation: {
        enabled: true,
        nextEl: '.swiper-button__next',
        prevEl: '.swiper-button__prev',
      },
      breakpoints: {
        0: {
          slidesPerView: 1.2,
          centeredSlides: true,
          loop: true
        },
        640: {
          slidesPerView: 2,
          centeredSlides: false,
          loop: true
        },
        1024: {
          slidesPerView: 4,
          centeredSlides: false,
          loop: true
        }
      },
      allowTouchMove: true,
      simulateTouch: true,
      effect: 'slide',
      grabCursor: true
    }
  })"
  class="pdp-related-products relative h-full w-full sm:px-10">

  <div x-ref="relatedProductsEl" class="swiper-container relative w-full h-full overflow-hidden">
    {%- comment -%} Slider Header {%- endcomment -%}
    {% assign title = section.settings.title %}
    {%- render 'slider-navbar',
      title: title,
      slider_navbar_class: 'px-5 sm:px-0'
    -%}

    <div class="swiper-wrapper">

      {%- comment -%} Step 1: Display Manually Selected Related Products {%- endcomment -%}
      {% for product in related_products %}
          {% liquid
            # Initialize variables for color and size option index
            assign color_option_index = ''
            assign size_option_index = ''
            assign available_sizes = null
            # Determine the indexes of the color and size options (e.g., option1, option2, etc.)
            for option in product.options_with_values
              case option.name
                when 'Color'
                  assign color_option_index = option.position
                  assign available_colors = option.values
                when 'Size'
                  assign size_option_index = option.position
                  assign available_sizes = option.values
              endcase
            endfor

            # Dynamically access the color and size based on their determined indexes
            assign color_option = 'option' | append: color_option_index
            assign size_option = 'option' | append: size_option_index
          -%}

        {% for color in available_colors %}
          {%- liquid
            # Get all variants of the color
            assign color_variants = product.variants | where: color_option, color
            # Get the first variant of the color
            assign first_color_variant = product.variants | where: color_option, color | first
            # Check if the first color variant is available
            assign is_first_color_variant_available = first_color_variant.available
            # If the first color variant is not available, get the first available variant
            unless is_first_product_variant_available == true
              for variant in color_variants
                if variant.available
                  assign first_color_variant = variant
                  break
                endif
              endfor
            endunless
          -%}

          <div class="swiper-slide">
            {% render 'product-variant-card',
              product: product,
              first_color_variant: first_color_variant,
              color: color,
              sorted_sizes: available_sizes,
              color_option: color_option,
              size_option: size_option
            %}
          </div>

          {%- comment -%} Increment the displayed products count {%- endcomment -%}
          {% assign displayed_products_count = displayed_products_count | plus: 1 %}
          {%- assign rendered_products = rendered_products | append: product.id | append: ',' -%}
        {% endfor %}
      {% endfor %}

      {%- comment -%} Step 2: Fill With Random Products (if less than 6 shown) {%- endcomment -%}
      {% for i in (0..all_products.size) %}
        {% comment %}
          Calculate a random product index by adding the loop index (i) to the random starting point (random_index),
          then wrap around the product list using modulo to prevent out-of-bounds errors.
        {% endcomment %}
        {% assign index_offset = i | plus: random_index %}
        {% assign product_index = index_offset | modulo: all_products.size %}
        {% assign product = all_products[product_index] %}
        {% if displayed_products_count < max_products %}
          {% unless rendered_products contains product.id or product.id == current_product_id %}
            {% liquid
              # Initialize variables for color and size option index
              assign color_option_index = ''
              assign size_option_index = ''
              assign available_sizes = null
              # Determine the indexes of the color and size options (e.g., option1, option2, etc.)
              for option in product.options_with_values
                case option.name
                  when 'Color'
                    assign color_option_index = option.position
                    assign available_colors = option.values
                  when 'Size'
                    assign size_option_index = option.position
                    assign available_sizes = option.values
                endcase
              endfor

              # Dynamically access the color and size based on their determined indexes
              assign color_option = 'option' | append: color_option_index
              assign size_option = 'option' | append: size_option_index
            -%}

            {% for color in available_colors %}
              {% if displayed_products_count < max_products %}
                {%- liquid
                  # Get the first variant of the color that is available
                  assign first_color_variant = product.variants | where: color_option, color | first
                -%}

                <div class="swiper-slide">
                  {% render 'product-variant-card',
                    product: product,
                    first_color_variant: first_color_variant,
                    color: color,
                    sorted_sizes: available_sizes,
                    color_option: color_option,
                    size_option: size_option
                  %}
                </div>

                {%- comment -%} Increment the displayed products count {%- endcomment -%}
                {% assign displayed_products_count = displayed_products_count | plus: 1 %}
                {%- assign rendered_products = rendered_products | append: product.id | append: ',' -%}
              {% endif %}
            {% endfor %}
          {% endunless %}
        {% endif %}
      {% endfor %}

    </div>
  </div>
</section>

{% schema %}
{
  "name": "Related Products",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Title"
    },
    {
      "type": "range",
      "id": "num_of_max_products",
      "step": 1,
      "min": 4,
      "max": 20,
      "label": "Maximum Number of Related Products",
      "info": "Manually selected products will be displayed first. Any remaining slots will automatically be filled with products chosen by Shopify.",
      "default": 6
    }
  ],
  "presets": [
    {
      "category": "Product",
      "name": "Related Products"
    }
  ]
}
{% endschema %}
