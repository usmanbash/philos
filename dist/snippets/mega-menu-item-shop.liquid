{%- comment -%}
Snippet: Mega Menu Item: Shop
Description: This snippet is used to render a mega menu for the shop.
It will display a list of links and up to 3 product cards.
Usage:
{% render 'mega-menu-item-shop', block: block %}

Accepts:
- block.settings.menu: The name of the linklist to display
- block.settings.product_1: The product to display in the first product card
- block.settings.product_2: The product to display in the second product card
- block.settings.product_3: The product to display in the third product card
{%- endcomment -%}

<div class="mega-menu-item mega-menu-item--shop flex flex-col lg:flex-row h-full w-full">
  <div class="lg:w-1/4 pr-2">
    <h2 class="sr-only">{{ "general.shop_all" | t }}</h2>
    <ul>
      {% assign menu_items = block.settings.menu %}
      {% for link in linklists[menu_items].links %}
        {%- comment -%}
        If the link type is a collection, we need to retrieve the collection from the link object
        and then use article_count to display the number of products in the collection.
        {%- endcomment -%}
        {%- liquid

          case link.type
            when 'collection_link'
              # Get the current collection from the link object
              assign current_collection = collections[link.object.handle]

              if current_collection
                assign total_color_count = 0
              # Get all products from the collection
                for product in current_collection.products
                  # Reset product_color_count for each product
                  assign product_color_count = 0

                  # Find the array of colors from options_with_values
                  for option in product.options_with_values
                    if option.name == 'Color'
                      # Count the number of colors available for this product
                      assign product_color_count = option.values | size
                    endif
                  endfor

                  # Accumulate the total color count across all products
                  assign total_color_count = total_color_count | plus: product_color_count
                endfor

                assign collection_product_count = total_color_count
              endif

            when 'catalog_link'
              # Get all products from the store
              assign all_products_collection = collections['all']
              if all_products_collection
                assign total_color_count = 0
                # Get all products from the collection
                for product in all_products_collection.products
                  assign product_color_count = 0

                  # Find the array of colors from options_with_values
                  for option in product.options_with_values
                    if option.name == 'Color'
                      # Count the number of colors available for this product
                      assign product_color_count = option.values | size
                    endif
                  endfor

                  # Accumulate the total color count across all products
                  assign total_color_count = total_color_count | plus: product_color_count
                endfor
              endif

            assign collection_product_count = total_color_count

            else
              assign collection_product_count = 0
          endcase
        -%}

        <li class='mb-2 last:mb-0 last:mt-10'>
          <a
            href='{{ link.url }}'
            aria-label="{{ 'general.check_out' | t }} {{ link.title | escape }}"
            class='link link--reversed pb-1 text-36 mb-2 last:mb-0'>
            <span class="link-title">{{ link.title }}</span>
            {% if collection_product_count > 0 %}
              <span class="align-top text-16">{{ collection_product_count }}</span>
            {% endif %}
          </a>
        </li>
      {% endfor %}
    </ul>
  </div>

  {%- comment -%} Product Cards {%- endcomment -%}
  <div class="lg:w-3/4 flex flex-col lg:flex-row">
    {% for i in (1..3) %}
      {%- assign product_key = 'product_' | append: i %}
      {%- assign product = block.settings[product_key] %}

      {% if product != blank %}
      {%- liquid
          # Initialize variables for color and size option index
          assign color_option_index = ''
          assign size_option_index = ''
          # Determine the indexes of the color and size options (e.g., option1, option2, etc.)
          for option in product.options_with_values
            case option.name
              when 'Color'
                assign color_option_index = option.position
                assign available_colors = option.values
              when 'Size'
                assign size_option_index = option.position
                assign available_sizes = option.values
            endcase
          endfor

          # Dynamically access the color and size based on their determined indexes
          assign color_option = 'option' | append: color_option_index
          assign size_option = 'option' | append: size_option_index
        -%}
        {%- liquid
            # Get all variants of the color
            assign color_variants = product.variants | where: color_option, color
            # Get the first variant of the color
            assign first_color_variant = product.variants | where: color_option, color | first
            # Check if the first color variant is available
            assign is_first_color_variant_available = first_color_variant.available
            # If the first color variant is not available, get the first available variant
            unless is_first_product_variant_available == true
              for variant in color_variants
                if variant.available
                  assign first_color_variant = variant
                  break
                endif
              endfor
            endunless
          -%}
        <div class="lg:w-1/3 lg:ml-5 first:ml-0">
          {% render 'product-variant-card',
            product: product,
            first_color_variant: first_color_variant,
            color: first_color_variant[color_option],
            sorted_sizes: available_sizes,
            color_option: color_option,
            size_option: size_option,
            is_menu: true
          %}
        </div>
      {% endif %}
    {% endfor %}
  </div>

</div>
