{%- comment -%}
Snippet: Mega Menu Item: Collection
Description: Renders a collection with a headline, text, and CTA, followed by up to 3 products based on SKUs.
{%- endcomment -%}

<div class="mega-menu-item mega-menu-item--collection flex flex-col lg:flex-row h-full w-full">
  <div class="lg:w-1/4 pr-10 xl:pr-32">
    {%- comment -%} First Column: Content {%- endcomment -%}
    <div class="flex flex-col w-full h-full justify-end">
      {%- liquid
        assign menu_collection = collections[block.settings.collection]
        assign collection_headline = block.settings.headline | default: menu_collection.title
        assign collection_description = block.settings.text | default: menu_collection.description
      -%}

      <h2 class="font-ivar text-46 mb-8">{{ collection_headline }}</h2>
      <div class="text-16 mb-8">{{ collection_description }}</div>

      {%- if menu_collection.url != blank -%}
        <a
          href="{{ menu_collection.url }}"
          aria-label="{{ 'general.check_out' | t }} {{ collection_headline | escape }}"
          class="text-24">
          <div class="link link--reversed">
            {{ block.settings.cta_text }}
          </div>
        </a>
      {%- endif -%}

      {%- comment -%} Additional CTA for the lookbook/special page {%- endcomment -%}
      {% if block.settings.page_url != blank %}
        <a
          href="{{ block.settings.page_url }}"
          aria-label="{{ 'general.check_out' | t }} {{ block.settings.cta_text_page | escape }}"
          class="mt-8 text-24">
          <span class="link link--reversed">
            {{ block.settings.cta_text_page }}
          </span>
        </a>
      {% endif %}
    </div>
  </div>

  {%- comment -%} Product Cards {%- endcomment -%}
  <div class="lg:w-3/4 flex flex-col lg:flex-row">

    {%- comment -%} Loop through the 3 products dynamically {%- endcomment -%}
    {% for i in (1..3) %}
      {%- assign product_key = 'product_' | append: i %}
      {%- assign sku_key = 'product_' | append: i | append: '_sku' %}
      {%- assign product = block.settings[product_key] %}
      {%- assign sku_to_check = block.settings[sku_key] %}

      {% if product != blank %}
      {%- liquid
          # Initialize variables for color and size option index
          assign color_option_index = ''
          assign size_option_index = ''
          # Determine the indexes of the color and size options (e.g., option1, option2, etc.)
          for option in product.options_with_values
            case option.name
              when 'Color'
                assign color_option_index = option.position
                assign available_colors = option.values
              when 'Size'
                assign size_option_index = option.position
                assign available_sizes = option.values
            endcase
          endfor

          # Dynamically access the color and size based on their determined indexes
          assign color_option = 'option' | append: color_option_index
          assign size_option = 'option' | append: size_option_index
        -%}

        {%- liquid
          assign matching_variant = null
          # Find the matching variant by SKU
          for variant in product.variants
            unless variant.sku == blank
            if variant.sku == sku_to_check
              assign matching_variant = variant
              break
            endif
            endunless
          endfor
          # If no matching variant found, get the first available variant
          assign all_variants = product.variants
          # Get the first variant
          assign first_product_variant = all_variants.first
          # Check if the first color variant is available
          assign is_first_product_variant_available = first_product_variant.available
          # If the first color variant is not available, get the first available variant
          unless is_first_product_variant_available == true
            for variant in all_variants
              if variant.available
                assign first_product_variant = variant
                break
              endif
            endfor
          endunless
        -%}

        {%- comment -%} Fallback to the first available variant if no match found {%- endcomment -%}
        {% assign variant_to_display = matching_variant |  default: first_product_variant %}
        {%- assign variant_to_display_color = variant_to_display[color_option] %}
        <div class="lg:w-1/3 lg:ml-5 first:ml-0">
          {% render 'product-variant-card',
            product: product,
            first_color_variant: variant_to_display,
            color: variant_to_display_color,
            sorted_sizes: available_sizes,
            color_option: color_option,
            size_option: size_option,
            is_menu: true
          %}
        </div>
      {% endif %}
    {% endfor %}
  </div>
</div>
